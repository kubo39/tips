# Gitの仕組み

## Gitとは

その時点においてのディレクトリ配下の全部のスナップショットを.git以下に保持する

Gitを構成するのは主に

- Gitオブジェクト (`.git/objects` ディレクトリに永続化)
- リファレンス (`.git/refs` ディレクトリに永続化)
- インデックス (`.git/index` ファイルに永続化)

という要素である

## Gitオブジェクト

Gitオブジェクトとは,

- ID: コンテンツのSHA-1ハッシュ
- コンテンツ: ヘッダ情報(Gitオブジェクトの種類と内容のサイズ) + 内容
    - 内容はBlobならファイルの中身、Commitならコミット情報(親のコミット、コメントなど)
    - をzlib圧縮したもの

(例えば、あるBlobは `blob 4\0 hoge` のようになる)

で構成されている.

Git Objectは4種類ある

- Blob: ファイルのスナップショット
- Tree: ディレクトリのスナップショット
- Commit: コミット情報を保持するオブジェクト
- Tag: アノテートタグにおいてTAGについての注釈を保持するためのオブジェクト
    - たいして使わないので今回は省略

### Blob

Blobオブジェクトとは: ファイルのスナップショット

- ファイルの中身をまるごとzlibで圧縮したものを内容として保持
- Blob自体は自身のファイル名さえ知らない
- ハッシュ値はファイルの内容が同じなら必ず同一になる -> ハッシュ値をみればファイルに変更があったかわかる！

### Tree

Treeオブジェクトとは: ディレクトリのスナップショット

- ファイルの種類,ファイル名,BlobのIDを内容として保持
- ファイルの種類: ディレクトリ,ファイル,symlink
- どこかのディレクトリのIDが変わるとルートまで必ず変更が検知できる
- コミット間で変わってないBlobは作り直さない -> 効率的な差分管理を実現

### Commit

Commitオブジェクトとは: いわゆるGitにおける歴史のページの単位. いつ・だれが・なんのためにファイルツリーを変更したかを管理する.

- 内容は
    1. ルートツリーのID
    2. 親コミットのID
    3. author
    4. committer
    5. コミットメッセージ
- コマンドラインで作業してるときにみるやつがこれ
- Treeのところでみたようにルートの情報だけもてば変更の有無が全部わかる

## リファレンス

リファレンス: Gitオブジェクトに任意の名前をつける機能. Commitオブジェクトで構成されたコミットツリーのある地点を参照するためのデータ.

- masterブランチと呼んでいるものはあるコミットから過去に辿れるコミットツリーに対して我々が名前をつけているだけ
- HEADは特別なリファレンスで現在チェックアウトしているブランチへの参照になっている
- 通常HEADはリファレンスに対するリファレンスとしてmasterやdevelopを参照
- なので直接commitオブジェクトを参照したときはdetached headと呼ばれる
    - その状態でもコミットはできる
    - ただしその場合HEADがさらに別の場所をさしたときどこからも参照されなくなる
        - どこからも参照されないとやがてgit gcで回収される
        - gcってうまい名前だね

## インデックス

インデックス: ファイル名とBlob(とメタデータ)の対応を保持. スナップショットを作成する対象となるファイルを登録する.

- Treeオブジェクトを作成するための情報を格納
    - `git add` を行うことでインデックスに対象ファイルの ファイル名/メタデータ/BlobのID を追加
        - これをステージングと呼ぶ
    - `git commit` 時にインデックスファイルからTreeオブジェクトを作成してCommitオブジェクトに追加
    - インデックスファイルはコミットしても別に消えたりしない

## コマンド

これらを踏まえてコマンドをみてみる

### `git add`

- インデックスのところでふれたようにインデックスファイルにファイル名やBlobオブジェクトの対応を格納するコマンド

### `git commit`

1. インデックスファイルからTreeオブジェクトを作る
2. TreeオブジェクトからCommitオブジェクトを作る
3. リファレンス `.git/refs/heads/現在のブランチ名` にCommitオブジェクトのIDを書く

ということをやっている
